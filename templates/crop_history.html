{% extends "base.html" %} {% block title %}Historial de {{ cultivo.nombre }} -
HuertoRentable{% endblock %} {% block chart_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %} {% block content %}
<div class="row mb-3">
  <div class="col-12 d-flex align-items-center justify-content-between">
    <h1 class="h4 text-success mb-0">
      <i class="bi bi-clock-history me-2"></i>
      Historial: <span class="text-capitalize">{{ cultivo.nombre }}</span>
    </h1>
    <button
      type="button"
      class="btn btn-outline-secondary"
      onclick="window.history.back()"
    >
      <i class="bi bi-arrow-left me-1"></i> Volver
    </button>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-header bg-success text-white">
    <i class="bi bi-graph-up me-2"></i>
    Producción por fecha
  </div>
  <div class="card-body">
    <div class="chart-container" style="position: relative; height: 350px">
      <canvas
        id="historyChart"
        data-labels="{{ chart_data.labels|tojson }}"
        data-unidades="{{ chart_data.unidades|tojson }}"
        data-kilos="{{ chart_data.kilos|tojson }}"
      ></canvas>
    </div>
    {% if chart_data.labels|length == 0 %}
    <p class="text-muted mt-2 mb-0">No hay registros de producción todavía.</p>
    {% endif %}
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header bg-light">
    <i class="bi bi-list-ul me-2"></i>
    Registros de producción
  </div>
  <div class="card-body p-0">
    {% if registros_view and registros_view|length > 0 %}
    <div class="table-responsive">
      <table class="table table-striped table-hover mb-0">
        <thead>
          <tr>
            <th style="width: 25%">Fecha</th>
            <th style="width: 15%">Hora</th>
            <th style="width: 20%">Unidades</th>
            <th style="width: 20%">Kilos</th>
          </tr>
        </thead>
        <tbody>
          {% for r in registros_view %}
          <tr>
            <td>{{ r.fecha_str }}</td>
            <td>{{ r.hora_str }}</td>
            <td>{{ r.unidades }}</td>
            <td>{{ '%.2f'|format(r.kilos) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted m-3">No hay registros para mostrar.</p>
    {% endif %}
  </div>
</div>
{% endblock %} {% block page_js %}
<script>
  // Igual que en analytics: consumimos chart_data seguro y dibujamos la gráfica
  document.addEventListener("DOMContentLoaded", function () {
    const chartDataEl = document.getElementById("chartData");
    let chartData = null;
    try {
      chartData = chartDataEl ? JSON.parse(chartDataEl.textContent) : null;
    } catch (e) {
      chartData = null;
    }
    if (!chartData || !chartData.labels || chartData.labels.length === 0) {
      return;
    }

    const labels = chartData.labels;
    const toNumeric = (arr) =>
      Array.isArray(arr)
        ? arr.map((v) =>
            v === null || v === undefined || v === "" ? null : Number(v)
          )
        : [];
    const n = labels.length;
    let unidades = toNumeric(chartData.unidades || []).slice(0, n);
    let kilos = toNumeric(chartData.kilos || []).slice(0, n);
    while (unidades.length < n) unidades.push(null);
    while (kilos.length < n) kilos.push(null);

    const hasUnidades = unidades.some((v) => (Number(v) || 0) > 0);
    const hasKilos = kilos.some((v) => (Number(v) || 0) > 0);

    const datasets = [];
    if (hasUnidades) {
      datasets.push({
        label: "Unidades",
        data: unidades,
        backgroundColor: "rgba(25, 135, 84, 0.15)",
        borderColor: "rgba(25, 135, 84, 1)",
        borderWidth: 2,
        fill: true,
        tension: 0.3,
        yAxisID: "y",
        pointRadius: 4,
      });
      if (hasKilos) {
        datasets.push({
          label: "Kilos",
          data: kilos,
          backgroundColor: "rgba(13, 110, 253, 0.15)",
          borderColor: "rgba(13, 110, 253, 1)",
          borderWidth: 2,
          fill: false,
          tension: 0.3,
          yAxisID: "y2",
          pointRadius: 3,
        });
      }
    } else if (hasKilos) {
      datasets.push({
        label: "Kilos",
        data: kilos,
        backgroundColor: "rgba(25, 135, 84, 0.15)",
        borderColor: "rgba(25, 135, 84, 1)",
        borderWidth: 2,
        fill: true,
        tension: 0.3,
        yAxisID: "y",
        pointRadius: 4,
      });
    }

    const el = document.getElementById("historyChart");
    if (!el) return;
    const ctx = el.getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: datasets,
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: "top" } },
        scales: {
          x: { title: { display: true, text: "Fecha" } },
          y: {
            beginAtZero: true,
            title: { display: true, text: hasUnidades ? "Unidades" : "Kilos" },
          },
          y2: {
            position: "right",
            grid: { drawOnChartArea: false },
            display: hasUnidades && hasKilos,
            title: { display: hasUnidades && hasKilos, text: "Kilos" },
          },
        },
      },
    });
  });
</script>
<script id="chartData" type="application/json">
  {{ chart_data|tojson }}
</script>
{% endblock %}
