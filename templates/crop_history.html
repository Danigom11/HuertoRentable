{% extends "base.html" %} {% block title %}Historial de {{ cultivo.nombre }} -
HuertoRentable{% endblock %} {% block chart_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %} {% block content %}
<div class="row mb-3">
  <div class="col-12 d-flex align-items-center justify-content-between">
    <h1 class="h4 text-success mb-0">
      <i class="bi bi-clock-history me-2"></i>
      Historial: <span class="text-capitalize">{{ cultivo.nombre }}</span>
    </h1>
    <button
      type="button"
      class="btn btn-outline-secondary"
      onclick="window.history.back()"
    >
      <i class="bi bi-arrow-left me-1"></i> Volver
    </button>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-header bg-success text-white">
    <i class="bi bi-graph-up me-2"></i>
    Producci√≥n por fecha
  </div>
  <div class="card-body">
    <div class="position-relative" style="height:320px;">
      <canvas
        id="historyChart"
        class="w-100 h-100"
        data-labels="{{ labels|tojson }}"
        data-unidades="{{ unidades|tojson }}"
        data-kilos="{{ kilos|tojson }}"
      ></canvas>
    </div>
    {% if not labels %}
    <div class="text-muted mt-2">No hay registros de producci√≥n a√∫n.</div>
    {% else %}
    <div class="mt-2 text-muted small">
      {% if unidades and unidades|sum > 0 %} üìä Mostrando unidades recolectadas
      por fecha {% elif kilos and kilos|sum > 0 %} üìä Mostrando kilos
      recolectados por fecha {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header bg-light">
    <i class="bi bi-list-ul me-2"></i>
    Registros de producci√≥n
  </div>
  <div class="card-body">
    {% if registros_view %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th>Fecha</th>
            <th>Hora</th>
            <th class="text-end">Unidades</th>
            <th class="text-end">Kilos</th>
          </tr>
        </thead>
        <tbody>
          {% for r in registros_view %}
          <tr>
            <td>{{ r.fecha_str }}</td>
            <td>{{ r.hora_str }}</td>
            <td class="text-end">{{ r.unidades }}</td>
            <td class="text-end">{{ r.kilos }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-muted">
      No hay entradas de producci√≥n para este cultivo.
    </div>
    {% endif %}
  </div>
</div>
{% endblock %} {% block page_js %}
<script>
  (function setupHistoryChartRenderer() {
    function renderChart() {
      try {
        const canvas = document.getElementById("historyChart");
        if (!canvas) return;

        // Parser robusto que maneja entidades HTML y dobles serializaciones
        const parseJsonAttr = (attrVal) => {
          if (!attrVal) return [];
          let raw = String(attrVal).trim();
          const attempts = [];
          attempts.push((s) => JSON.parse(s));
          attempts.push((s) =>
            JSON.parse(
              s
                .replaceAll("&quot;", '"')
                .replaceAll("&#34;", '"')
                .replaceAll("&amp;", "&")
            )
          );
          attempts.push((s) => {
            // A veces viene entrecomillado: "[1,2]" => [1,2]
            if (
              (s.startsWith('"') && s.endsWith('"')) ||
              (s.startsWith("'") && s.endsWith("'"))
            ) {
              return JSON.parse(s.slice(1, -1));
            }
            throw new Error("No quoted JSON");
          });
          for (const attempt of attempts) {
            try {
              return attempt(raw);
            } catch (_) {}
          }
          return [];
        };

        const labels = parseJsonAttr(
          canvas.getAttribute("data-labels") || "[]"
        );
        const unidades = parseJsonAttr(
          canvas.getAttribute("data-unidades") || "[]"
        );
        const kilos = parseJsonAttr(canvas.getAttribute("data-kilos") || "[]");
    // Normalizar arrays a num√©ricos y alinear longitudes con labels
    const toNumeric = (arr) => Array.isArray(arr) ? arr.map((v) => (v === null || v === undefined || v === "" ? null : Number(v))) : [];
    const n = Array.isArray(labels) ? labels.length : 0;
    const unidadesNum = toNumeric(unidades).slice(0, n);
    const kilosNum = toNumeric(kilos).slice(0, n);
    while (unidadesNum.length < n) unidadesNum.push(null);
    while (kilosNum.length < n) kilosNum.push(null);

        if (!window.Chart) {
          console.warn("Chart.js no est√° disponible");
          return;
        }

        if (labels.length === 0) return;

        const ctx = canvas.getContext("2d");
        // Destruir gr√°fico previo si existe para evitar fugas o no-repintado
        if (canvas._hrChartInstance) {
          try {
            canvas._hrChartInstance.destroy();
          } catch (e) {}
          canvas._hrChartInstance = null;
        }
        const datasets = [];
    const maxUnidades = unidadesNum.reduce(
          (m, v) => Math.max(m, Number(v) || 0),
          0
        );
    const maxKilos = kilosNum.reduce((m, v) => Math.max(m, Number(v) || 0), 0);

        // Determinar qu√© datos mostrar basado en lo que est√° disponible
  const hasUnidades = unidadesNum.some((v) => (Number(v) || 0) > 0);
  const hasKilos = kilosNum.some((v) => (Number(v) || 0) > 0);

        if (hasUnidades) {
          // Priorizar unidades si est√°n disponibles
          datasets.push({
            label: "Unidades",
            data: unidades,
              data: unidadesNum,
            borderColor: "#198754",
            backgroundColor: "rgba(25, 135, 84, 0.15)",
            tension: 0.2,
            fill: true,
            pointRadius: 5,
            pointHoverRadius: 7,
            yAxisID: "y",
          });

          // A√±adir kilos como eje secundario si tambi√©n est√°n disponibles
          if (hasKilos) {
            datasets.push({
              label: "Kilos",
              data: kilos,
                data: kilosNum,
              borderColor: "#0d6efd",
              backgroundColor: "rgba(13, 110, 253, 0.15)",
              tension: 0.2,
              fill: false,
              pointRadius: 3,
              pointHoverRadius: 5,
              yAxisID: "y2",
            });
          }
        } else if (hasKilos) {
          // Si solo hay kilos, mostrar solo kilos
          datasets.push({
            label: "Kilos",
            data: kilos,
              data: kilosNum,
            borderColor: "#198754",
            backgroundColor: "rgba(25, 135, 84, 0.15)",
            tension: 0.2,
            fill: true,
            pointRadius: 5,
            pointHoverRadius: 7,
            yAxisID: "y",
          });
        }

        const chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: datasets,
          },
          options: {
            responsive: true,
              maintainAspectRatio: false,
            scales: {
              x: { title: { display: true, text: "Fecha" } },
              y: {
                title: {
                  display: true,
                  text: hasUnidades ? "Unidades" : "Kilos",
                },
                beginAtZero: true,
                suggestedMax: Math.max(
                  1,
                  (hasUnidades ? maxUnidades : maxKilos) * 1.2
                ),
              },
              y2: {
                position: "right",
                title: { display: hasUnidades && hasKilos, text: "Kilos" },
                beginAtZero: true,
                grid: { drawOnChartArea: false },
                suggestedMax: Math.max(1, maxKilos * 1.2),
                display: hasUnidades && hasKilos, // Solo mostrar si hay ambos
              },
            },
            plugins: {
              legend: { display: true },
              tooltip: {
                enabled: true,
                callbacks: {
                  title: function (tooltipItems) {
                    return tooltipItems[0].label;
                  },
                  label: function (context) {
                    const label = context.dataset.label || "";
                    const value = context.raw;
                    if (label === "Unidades") {
                      return `${label}: ${value} unidades`;
                    } else if (label === "Kilos") {
                      return `${label}: ${value} kg`;
                    }
                    return `${label}: ${value}`;
                  },
                },
              },
            },
          },
        });
        canvas._hrChartInstance = chart;
      } catch (err) {
        console.error("Error renderizando gr√°fico de historial", err);
      }
    }
    // Pintar al cargar y al volver con BFCache (pageshow persistente)
    document.addEventListener("DOMContentLoaded", function () {
      // Peque√±o retraso para asegurar que estilos y fuentes est√©n aplicados
      setTimeout(renderChart, 0);
    });
    window.addEventListener("pageshow", function (event) {
      // Si viene del cache del navegador, re-render
      if (event.persisted) {
        renderChart();
      }
    });
    // Fallback: reintento si datasets quedaron vac√≠os por cualquier motivo
    setTimeout(() => {
      const canvas = document.getElementById("historyChart");
      if (
        canvas &&
        (!canvas._hrChartInstance ||
          canvas._hrChartInstance.data.datasets.length === 0)
      ) {
        renderChart();
      }
    }, 300);
  })();
</script>
{% endblock %}
