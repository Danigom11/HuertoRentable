<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Firebase Authentication - HuertoRentable</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-box {
        border: 1px solid #ccc;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
      }
      .warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
      }
      .form-group {
        margin: 10px 0;
      }
      input {
        padding: 8px;
        margin: 5px;
        width: 200px;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ§ª Test Completo Firebase Authentication - HuertoRentable</h1>

    <div id="testResults"></div>

    <div class="test-box">
      <h3>ğŸ”§ Tests AutomÃ¡ticos</h3>
      <button onclick="runAllTests()" id="runTestsBtn">
        ğŸš€ Ejecutar Todos los Tests
      </button>
    </div>

    <div class="test-box">
      <h3>ğŸ“ Test Manual de Registro</h3>
      <form id="testForm">
        <div class="form-group">
          <label>Email:</label><br />
          <input
            type="email"
            id="testEmail"
            placeholder="Email de prueba"
            required
          />
        </div>
        <div class="form-group">
          <label>ContraseÃ±a:</label><br />
          <input
            type="password"
            id="testPassword"
            placeholder="ContraseÃ±a (min 6 caracteres)"
            required
          />
        </div>
        <div class="form-group">
          <label>Nombre:</label><br />
          <input type="text" id="testName" placeholder="Nombre completo" />
        </div>
        <button type="submit">ğŸš€ Probar Registro Manual</button>
      </form>
      <p>
        <small
          >ğŸ’¡ El email serÃ¡ generado automÃ¡ticamente con timestamp para evitar
          duplicados</small
        >
      </p>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- ConfiguraciÃ³n Firebase -->
    <script src="static/js/firebase-config.js"></script>
    <script src="static/js/auth-service.js"></script>

    <script>
      const resultsDiv = document.getElementById("testResults");
      let testCount = 0;

      function addResult(message, type = "info") {
        testCount++;
        const div = document.createElement("div");
        div.className = `test-box ${type}`;
        div.innerHTML = `<strong>Test ${testCount}:</strong> ${new Date().toLocaleTimeString()}: ${message}`;
        resultsDiv.appendChild(div);
        console.log(`Test ${testCount}: ${message}`);

        // Auto-scroll al Ãºltimo resultado
        div.scrollIntoView({ behavior: "smooth", block: "end" });
      }

      async function runAllTests() {
        const btn = document.getElementById("runTestsBtn");
        btn.disabled = true;
        btn.textContent = "â³ Ejecutando tests...";

        resultsDiv.innerHTML = ""; // Limpiar resultados anteriores
        testCount = 0;

        try {
          // Test 1: Verificar que Firebase SDK estÃ© cargado
          addResult("ğŸ” Verificando Firebase SDK...", "info");
          if (typeof firebase !== "undefined") {
            addResult(
              `âœ… Firebase SDK cargado correctamente (versiÃ³n: ${
                firebase.SDK_VERSION || "desconocida"
              })`,
              "success"
            );
          } else {
            addResult("âŒ Firebase SDK no estÃ¡ disponible", "error");
            return;
          }

          // Test 2: Verificar HuertoFirebase config
          addResult("ğŸ” Verificando configuraciÃ³n HuertoFirebase...", "info");
          if (window.HuertoFirebase) {
            addResult("âœ… HuertoFirebase configuraciÃ³n disponible", "success");
            const status = window.HuertoFirebase.getStatus();
            addResult(
              `ğŸ“Š Estado Firebase: SDK: ${status.sdkLoaded}, Apps: ${status.appsInitialized}`,
              "info"
            );
          } else {
            addResult("âŒ HuertoFirebase configuraciÃ³n no disponible", "error");
            return;
          }

          // Test 3: Inicializar Firebase
          addResult("ğŸ” Inicializando Firebase...", "info");
          try {
            const initialized = window.HuertoFirebase.initialize();
            if (initialized) {
              addResult("âœ… Firebase inicializado correctamente", "success");
            } else {
              addResult("âŒ Error al inicializar Firebase", "error");
              return;
            }
          } catch (error) {
            addResult(
              `âŒ Error al inicializar Firebase: ${error.message}`,
              "error"
            );
            return;
          }

          // Test 4: Verificar Firebase Auth
          addResult("ğŸ” Verificando Firebase Auth...", "info");
          try {
            const auth = firebase.auth();
            addResult("âœ… Firebase Auth disponible", "success");

            // Verificar configuraciÃ³n Auth
            addResult(`ğŸ“§ AuthDomain: ${auth.app.options.authDomain}`, "info");
            addResult(`ğŸ†” ProjectId: ${auth.app.options.projectId}`, "info");
          } catch (error) {
            addResult(
              `âŒ Firebase Auth no disponible: ${error.message}`,
              "error"
            );
            return;
          }

          // Test 5: Verificar AuthService
          addResult("ğŸ” Verificando AuthService...", "info");
          if (window.authService) {
            addResult("âœ… AuthService disponible", "success");

            // Inicializar AuthService
            await window.authService.initialize();
            addResult(
              `ğŸ“Š AuthService Firebase Ready: ${window.authService.isFirebaseReady}`,
              "info"
            );
          } else {
            addResult("âŒ AuthService no disponible", "error");
          }

          // Test 6: Test de conexiÃ³n a backend
          addResult("ğŸ” Probando conexiÃ³n al backend...", "info");
          try {
            const response = await fetch("/dashboard");
            if (response.ok) {
              addResult("âœ… ConexiÃ³n al backend exitosa", "success");
            } else {
              addResult(
                `âš ï¸ Backend responde pero con status: ${response.status}`,
                "warning"
              );
            }
          } catch (error) {
            addResult(
              `âŒ Error de conexiÃ³n al backend: ${error.message}`,
              "error"
            );
          }

          addResult("ğŸ‰ Todos los tests completados", "success");
        } catch (error) {
          addResult(`âŒ Error durante los tests: ${error.message}`, "error");
        } finally {
          btn.disabled = false;
          btn.textContent = "ğŸš€ Ejecutar Todos los Tests";
        }
      }

      // Test de registro manual
      document
        .getElementById("testForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          // Generar email Ãºnico con timestamp
          const timestamp = Date.now();
          const baseEmail =
            document.getElementById("testEmail").value || "test@example.com";
          const uniqueEmail = baseEmail.replace("@", `+${timestamp}@`);

          const password =
            document.getElementById("testPassword").value || "123456";
          const name =
            document.getElementById("testName").value || "Usuario Test";

          addResult(
            `ğŸ§ª Iniciando registro manual con email: ${uniqueEmail}`,
            "info"
          );

          try {
            if (!window.authService) {
              throw new Error("AuthService no estÃ¡ disponible");
            }

            addResult("ğŸ“¤ Llamando a authService.register()...", "info");
            const result = await window.authService.register(
              uniqueEmail,
              password,
              name,
              "gratuito"
            );

            if (result.success) {
              addResult(
                `âœ… Registro exitoso! Usuario: ${result.user.email}`,
                "success"
              );
              addResult(
                `ğŸ“ Detalles: UID: ${result.user.uid}, Plan: ${result.user.plan}`,
                "info"
              );

              if (result.message) {
                addResult(`ğŸ’¬ Mensaje del servidor: ${result.message}`, "info");
              }
            } else {
              addResult(`âŒ Registro fallÃ³: ${result.error}`, "error");
            }
          } catch (error) {
            addResult(`âŒ Error en registro manual: ${error.message}`, "error");
            console.error("Error completo:", error);
          }
        });

      // Ejecutar tests bÃ¡sicos al cargar la pÃ¡gina
      window.addEventListener("load", () => {
        setTimeout(() => {
          addResult("ğŸ PÃ¡gina cargada, iniciando tests bÃ¡sicos...", "info");
          runAllTests();
        }, 1000);
      });
    </script>
  </body>
</html>
