<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diagn√≥stico Firebase - HuertoRentable</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container mt-4">
      <h2>üîß Diagn√≥stico Firebase</h2>
      <div class="row">
        <div class="col-md-8">
          <div class="card">
            <div class="card-body">
              <h5>Estado del Sistema</h5>
              <div id="diagnostico"></div>
              <button onclick="testFirebase()" class="btn btn-primary mt-3">
                Probar Firebase
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase Scripts - COMPAT VERSION -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <!-- Tu archivo de configuraci√≥n -->
    <script src="{{ url_for('static', filename='js/firebase-config-final.js') }}"></script>

    <script>
      function addLog(message, type = "info") {
        const div = document.getElementById("diagnostico");
        const alertClass =
          type === "error"
            ? "alert-danger"
            : type === "success"
            ? "alert-success"
            : "alert-info";
        div.innerHTML += `<div class="alert ${alertClass} alert-sm">${message}</div>`;
      }

      function testFirebase() {
        document.getElementById("diagnostico").innerHTML = "";

        addLog("üöÄ Iniciando diagn√≥stico Firebase...", "info");

        // Test 1: Firebase SDK
        if (typeof firebase === "undefined") {
          addLog("‚ùå Firebase SDK no est√° cargado", "error");
          return;
        }
        addLog("‚úÖ Firebase SDK cargado", "success");

        // Test 2: HuertoFirebase
        if (typeof window.HuertoFirebase === "undefined") {
          addLog("‚ùå HuertoFirebase no disponible", "error");
          return;
        }
        addLog("‚úÖ HuertoFirebase disponible", "success");

        // Test 3: Configuraci√≥n
        if (!window.HuertoFirebase.config) {
          addLog("‚ùå Configuraci√≥n Firebase no disponible", "error");
          return;
        }
        addLog("‚úÖ Configuraci√≥n Firebase disponible", "success");
        addLog(`üìù API Key: ${window.HuertoFirebase.config.apiKey}`, "info");
        addLog(
          `üìù Project ID: ${window.HuertoFirebase.config.projectId}`,
          "info"
        );

        // Test 4: Inicializaci√≥n
        try {
          const result = window.HuertoFirebase.initialize();
          if (result) {
            addLog("‚úÖ Firebase inicializado correctamente", "success");

            // Test 5: Auth
            try {
              const auth = firebase.auth();
              addLog("‚úÖ Firebase Auth disponible", "success");

              // Test 6: Crear usuario de prueba
              addLog("üîÑ Probando creaci√≥n de usuario...", "info");
              auth
                .createUserWithEmailAndPassword("test@test.com", "test123")
                .then((result) => {
                  addLog("‚úÖ ¬°Usuario creado exitosamente!", "success");
                  addLog(`üë§ UID: ${result.user.uid}`, "info");
                  // Eliminar usuario de prueba
                  result.user.delete();
                })
                .catch((error) => {
                  if (error.code === "auth/email-already-in-use") {
                    addLog(
                      "‚úÖ Authentication funciona (email ya existe)",
                      "success"
                    );
                  } else {
                    addLog(
                      `‚ùå Error en authentication: ${error.message}`,
                      "error"
                    );
                  }
                });
            } catch (authError) {
              addLog(`‚ùå Error obteniendo Auth: ${authError.message}`, "error");
            }
          } else {
            addLog("‚ùå Error inicializando Firebase", "error");
          }
        } catch (initError) {
          addLog(`‚ùå Error en inicializaci√≥n: ${initError.message}`, "error");
        }
      }

      // Auto-ejecutar al cargar
      document.addEventListener("DOMContentLoaded", function () {
        addLog("üìÑ P√°gina cargada", "info");
        setTimeout(testFirebase, 1000);
      });
    </script>
  </body>
</html>
